{% extends 'customer/dashboard.html' %}
{% block content %}
<div class="card" style="max-width: 600px; margin: 2rem auto;">
    <div class="card-header">
        <h2 class="card-title">Share Your Experience</h2>
        <p class="card-subtitle">Help other customers by reviewing your rental experience</p>
    </div>
    <div class="card-body">
        <!-- Booking Details -->
        <div class="booking-summary">
            <div class="booking-header">
                <h4>Booking #{{ booking.id }}</h4>
                <div class="booking-details">
                    <div class="detail-item">
                        <span class="detail-label">Vehicle:</span>
                        <span class="detail-value">{{ booking.make }} {{ booking.model }} ({{ booking.year }})</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Rental Period:</span>
                        <span class="detail-value">{{ booking.start_date.strftime('%b %d, %Y at %I:%M %p') }} - {{ booking.end_date.strftime('%b %d, %Y at %I:%M %p') }}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Total Amount:</span>
                        <span class="detail-value">₹{{ "%.2f"|format(booking.total_price) }}</span>
                    </div>
                </div>
            </div>
        </div>

        <hr style="margin: 2rem 0; border-color: var(--neutral-200);">

        {% if review %}
            <!-- Existing Review Display -->
            <div class="existing-review">
                <h4>Your Review</h4>
                <div class="review-display">
                    <div class="star-rating-display">
                        {% for i in range(1, 6) %}
                            <span class="star {% if i <= review.rating %}filled{% endif %}">★</span>
                        {% endfor %}
                        <span class="rating-text">{{ review.rating }}/5</span>
                    </div>
                    <div class="review-comment">
                        <p>{{ review.comment }}</p>
                    </div>
                    <div class="review-date">
                        Reviewed on {{ review.review_date.strftime('%B %d, %Y') }}
                    </div>
                </div>
                <div class="review-actions">
                    <a href="{{ url_for('customer_dashboard') }}" class="btn btn-secondary">Back to Dashboard</a>
                </div>
            </div>
        {% else %}
            <!-- Review Form -->
            <div id="review-message" tabindex="-1" style="outline: none;" aria-live="polite"></div>
            
            <form method="POST" id="review-form" novalidate>
                <!-- Star Rating -->
                <div class="form-group">
                    <label class="form-label">Overall Rating</label>
                    <div class="star-rating-container">
                        <div class="star-rating" id="star-rating">
                            <span class="star" data-rating="1">★</span>
                            <span class="star" data-rating="2">★</span>
                            <span class="star" data-rating="3">★</span>
                            <span class="star" data-rating="4">★</span>
                            <span class="star" data-rating="5">★</span>
                        </div>
                        <input type="hidden" name="rating" id="rating-input" required>
                        <div class="rating-description" id="rating-description">Click to rate your experience</div>
                    </div>
                </div>

                <!-- Review Categories -->
                <div class="form-group">
                    <label class="form-label">Rate Specific Aspects</label>
                    <div class="rating-categories">
                        <div class="category-item">
                            <label>Vehicle Condition</label>
                            <div class="category-stars" data-category="condition">
                                <span class="star" data-rating="1">★</span>
                                <span class="star" data-rating="2">★</span>
                                <span class="star" data-rating="3">★</span>
                                <span class="star" data-rating="4">★</span>
                                <span class="star" data-rating="5">★</span>
                            </div>
                        </div>
                        <div class="category-item">
                            <label>Service Quality</label>
                            <div class="category-stars" data-category="service">
                                <span class="star" data-rating="1">★</span>
                                <span class="star" data-rating="2">★</span>
                                <span class="star" data-rating="3">★</span>
                                <span class="star" data-rating="4">★</span>
                                <span class="star" data-rating="5">★</span>
                            </div>
                        </div>
                        <div class="category-item">
                            <label>Value for Money</label>
                            <div class="category-stars" data-category="value">
                                <span class="star" data-rating="1">★</span>
                                <span class="star" data-rating="2">★</span>
                                <span class="star" data-rating="3">★</span>
                                <span class="star" data-rating="4">★</span>
                                <span class="star" data-rating="5">★</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Review Comment -->
                <div class="form-group">
                    <label for="comment" class="form-label">Share Your Experience</label>
                    <textarea 
                        name="comment" 
                        id="comment" 
                        class="form-input" 
                        rows="5" 
                        placeholder="Tell us about your rental experience. What did you like? What could be improved? Your feedback helps us provide better service to other customers."
                        maxlength="500"
                    ></textarea>
                    <div class="char-counter">
                        <span id="char-count">0</span>/500 characters
                    </div>
                </div>

                <!-- Would You Recommend -->
                <div class="form-group">
                    <label class="form-label">Would you recommend us to others?</label>
                    <div class="recommendation-options">
                        <label class="radio-option">
                            <input type="radio" name="recommend" value="yes" required>
                            <span class="radio-custom"></span>
                            <span class="radio-label">Yes, definitely!</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="recommend" value="maybe" required>
                            <span class="radio-custom"></span>
                            <span class="radio-label">Maybe</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="recommend" value="no" required>
                            <span class="radio-custom"></span>
                            <span class="radio-label">No, probably not</span>
                        </label>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary btn-full btn-lg" id="submit-review">
                        <svg class="icon icon-sm" viewBox="0 0 24 24">
                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                        </svg>
                        Submit Review
                    </button>
                    <a href="{{ url_for('customer_dashboard') }}" class="btn btn-ghost btn-full">Cancel</a>
                </div>
            </form>
        {% endif %}
    </div>
</div>

<style>
/* Review Page Specific Styles */
.booking-summary {
    background: var(--primary-50);
    border-radius: var(--radius-xl);
    padding: var(--space-6);
    margin-bottom: var(--space-6);
}

.booking-header h4 {
    color: var(--primary-700);
    margin-bottom: var(--space-4);
    font-weight: 700;
}

.booking-details {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
}

.detail-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.detail-label {
    font-weight: 600;
    color: var(--neutral-600);
}

.detail-value {
    color: var(--neutral-800);
    font-weight: 500;
}

/* Star Rating Styles */
.star-rating-container {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
}

.star-rating, .category-stars {
    display: flex;
    gap: var(--space-1);
    font-size: 2rem;
    color: var(--neutral-300);
}

.star {
    cursor: pointer;
    transition: all var(--transition-fast);
    user-select: none;
}

.star:hover,
.star.filled {
    color: #ffd700;
    transform: scale(1.1);
}

.star-rating-display {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-size: 1.5rem;
}

.star-rating-display .star {
    cursor: default;
}

.star-rating-display .star.filled {
    color: #ffd700;
}

.rating-text {
    font-weight: 600;
    color: var(--neutral-700);
}

.rating-description {
    font-size: var(--text-sm);
    color: var(--neutral-500);
    font-style: italic;
}

/* Rating Categories */
.rating-categories {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
}

.category-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-3);
    background: var(--neutral-50);
    border-radius: var(--radius-lg);
}

.category-item label {
    font-weight: 600;
    color: var(--neutral-700);
    min-width: 120px;
}

.category-stars {
    font-size: 1.25rem;
}

/* Character Counter */
.char-counter {
    text-align: right;
    font-size: var(--text-sm);
    color: var(--neutral-500);
    margin-top: var(--space-1);
}

/* Recommendation Options */
.recommendation-options {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
}

.radio-option {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    cursor: pointer;
    padding: var(--space-3);
    border-radius: var(--radius-lg);
    transition: background var(--transition-fast);
}

.radio-option:hover {
    background: var(--neutral-50);
}

.radio-option input[type="radio"] {
    display: none;
}

.radio-custom {
    width: 20px;
    height: 20px;
    border: 2px solid var(--neutral-300);
    border-radius: 50%;
    position: relative;
    transition: all var(--transition-fast);
}

.radio-option input[type="radio"]:checked + .radio-custom {
    border-color: var(--accent-main);
    background: var(--accent-main);
}

.radio-option input[type="radio"]:checked + .radio-custom::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 8px;
    height: 8px;
    background: white;
    border-radius: 50%;
}

.radio-label {
    font-weight: 500;
    color: var(--neutral-700);
}

/* Form Actions */
.form-actions {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
    margin-top: var(--space-6);
}

/* Existing Review Display */
.existing-review {
    text-align: center;
}

.review-display {
    background: var(--success-50);
    border: 1px solid var(--success-200);
    border-radius: var(--radius-xl);
    padding: var(--space-6);
    margin: var(--space-4) 0;
}

.review-comment {
    margin: var(--space-4) 0;
    font-style: italic;
    color: var(--neutral-700);
}

.review-date {
    font-size: var(--text-sm);
    color: var(--neutral-500);
}

.review-actions {
    margin-top: var(--space-4);
}

/* Responsive Design */
@media (max-width: 768px) {
    .detail-item {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--space-1);
    }
    
    .category-item {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--space-2);
    }
    
    .star-rating, .category-stars {
        font-size: 1.5rem;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('review-form');
    const ratingInput = document.getElementById('rating-input');
    const ratingDescription = document.getElementById('rating-description');
    const commentTextarea = document.getElementById('comment');
    const charCount = document.getElementById('char-count');
    const submitButton = document.getElementById('submit-review');

    // Star rating functionality
    const starRating = document.getElementById('star-rating');
    const stars = starRating.querySelectorAll('.star');
    
    const ratingDescriptions = {
        1: 'Poor - Very dissatisfied',
        2: 'Fair - Somewhat dissatisfied', 
        3: 'Good - Satisfied',
        4: 'Very Good - Very satisfied',
        5: 'Excellent - Extremely satisfied'
    };

    stars.forEach(star => {
        star.addEventListener('click', function() {
            const rating = parseInt(this.dataset.rating);
            ratingInput.value = rating;
            
            // Update star display
            stars.forEach((s, index) => {
                if (index < rating) {
                    s.classList.add('filled');
                } else {
                    s.classList.remove('filled');
                }
            });
            
            // Update description
            ratingDescription.textContent = ratingDescriptions[rating];
        });
        
        star.addEventListener('mouseenter', function() {
            const rating = parseInt(this.dataset.rating);
            stars.forEach((s, index) => {
                if (index < rating) {
                    s.style.color = '#ffd700';
                }
            });
        });
        
        star.addEventListener('mouseleave', function() {
            const currentRating = parseInt(ratingInput.value) || 0;
            stars.forEach((s, index) => {
                if (index < currentRating) {
                    s.style.color = '#ffd700';
                } else {
                    s.style.color = 'var(--neutral-300)';
                }
            });
        });
    });

    // Category star ratings
    const categoryStars = document.querySelectorAll('.category-stars');
    categoryStars.forEach(container => {
        const stars = container.querySelectorAll('.star');
        stars.forEach(star => {
            star.addEventListener('click', function() {
                const rating = parseInt(this.dataset.rating);
                const category = container.dataset.category;
                
                // Update stars for this category
                stars.forEach((s, index) => {
                    if (index < rating) {
                        s.classList.add('filled');
                    } else {
                        s.classList.remove('filled');
                    }
                });
                
                // Store category rating (you can add hidden inputs if needed)
                console.log(`${category} rating: ${rating}`);
            });
        });
    });

    // Character counter
    commentTextarea.addEventListener('input', function() {
        const count = this.value.length;
        charCount.textContent = count;
        
        if (count > 450) {
            charCount.style.color = '#e74c3c';
        } else if (count > 400) {
            charCount.style.color = '#f39c12';
        } else {
            charCount.style.color = 'var(--neutral-500)';
        }
    });

    // Form validation
    form.addEventListener('submit', function(e) {
        const rating = parseInt(ratingInput.value);
        const comment = commentTextarea.value.trim();
        
        if (!rating || rating < 1 || rating > 5) {
            e.preventDefault();
            showMessage('Please select a rating between 1 and 5 stars.', 'error');
            return;
        }
        
        if (comment.length < 10) {
            e.preventDefault();
            showMessage('Please provide a detailed review (at least 10 characters).', 'error');
            return;
        }
        
        // Disable submit button to prevent double submission
        submitButton.disabled = true;
        submitButton.innerHTML = '<svg class="icon icon-sm spin" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none" stroke-dasharray="31.416" stroke-dashoffset="31.416"><animate attributeName="stroke-dasharray" dur="2s" values="0 31.416;15.708 15.708;0 31.416" repeatCount="indefinite"/><animate attributeName="stroke-dashoffset" dur="2s" values="0;-15.708;-31.416" repeatCount="indefinite"/></circle></svg> Submitting...';
    });

    function showMessage(message, type) {
        const messageDiv = document.getElementById('review-message');
        messageDiv.textContent = message;
        messageDiv.className = `alert alert-${type}`;
        messageDiv.style.display = 'block';
        
        setTimeout(() => {
            messageDiv.style.display = 'none';
        }, 5000);
    }
});
</script>
{% endblock %} 