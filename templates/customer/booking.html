<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Vehicle - DriveEase</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/modern-design-system.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/layout.css') }}">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
</head>
<body>
    <!-- Top Navigation Bar -->
    <header class="top-nav">
        <div class="brand-logo">
            <div class="sidebar-logo">
                <svg class="icon" viewBox="0 0 24 24">
                    <path d="M7 17m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0"/>
                    <path d="M17 17m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0"/>
                    <path d="M5 17h-2v-6l2-5h9l4 5h1a2 2 0 0 1 2 2v4h-2"/>
                </svg>
            </div>
            <div>
                <div class="sidebar-title">DriveEase</div>
                <div class="sidebar-subtitle">Customer Portal</div>
            </div>
        </div>
        <nav class="top-nav-links">
            <a href="{{ url_for('customer_dashboard') }}" class="top-nav-link">Dashboard</a>
            <a href="{{ url_for('customer_booking') }}" class="top-nav-link">Book Vehicle</a>
            <a href="{{ url_for('customer_profile') }}" class="top-nav-link">My Profile</a>
            <a href="{{ url_for('logout') }}" class="top-nav-link">Logout</a>
        </nav>
    </header>
    <main class="main-content">
            <!-- Page Header -->
            <div class="page-header">
                <div>
                    <h1 class="page-title">Book Your Vehicle</h1>
                    <p class="page-subtitle">Choose from our premium fleet and enjoy seamless booking experience</p>
                </div>
            </div>

            <!-- Booking Form -->
            <div class="booking-section">
                <div class="grid grid-cols-2">
                    <!-- Booking Form -->
                    <div class="card animate-slide-in-left">
                        <div class="card-header">
                            <h3 class="card-title">Booking Details</h3>
                            <div class="booking-step">Step 1 of 2</div>
                        </div>
                        <!-- Custom error/confirmation message area -->
                        <div id="booking-message" tabindex="-1" style="outline: none;" aria-live="polite"></div>
                        <form id="booking-form" class="booking-form" method="POST" action="{{ url_for('customer_payment') }}" novalidate>
                            <div class="form-group">
                                <label for="vehicle_id" class="form-label">
                                    <svg class="icon icon-sm" viewBox="0 0 24 24">
                                        <path d="M7 17m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0"/>
                                        <path d="M17 17m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0"/>
                                        <path d="M5 17h-2v-6l2-5h9l4 5h1a2 2 0 0 1 2 2v4h-2"/>
                                    </svg>
                                    Select Vehicle
                                </label>
                                <select id="vehicle_id" name="vehicle_id" class="form-select" required>
                                    <option value="">Choose your vehicle...</option>
                                    {% for vehicle in vehicles %}
                                    <option value="{{ vehicle.id }}" 
                                            data-price="{{ vehicle.base_price }}" 
                                            data-lat="{{ vehicle.pickup_location_lat }}" 
                                            data-lng="{{ vehicle.pickup_location_lng }}"
                                            data-image="{{ vehicle.image_url }}"
                                            data-type="{{ vehicle.type }}">
                                        {{ vehicle.make }} {{ vehicle.model }} ({{ vehicle.year }}) - â‚¹{{ "%.2f"|format(vehicle.base_price) }}/hour
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="start_date" class="form-label">
                                        <svg class="icon icon-sm" viewBox="0 0 24 24">
                                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                            <line x1="16" y1="2" x2="16" y2="6"/>
                                            <line x1="8" y1="2" x2="8" y2="6"/>
                                            <line x1="3" y1="10" x2="21" y2="10"/>
                                        </svg>
                                        Start Date & Time
                                    </label>
                                    <input type="datetime-local" id="start_date" name="start_date" class="form-input" required>
                                </div>

                                <div class="form-group">
                                    <label for="end_date" class="form-label">
                                        <svg class="icon icon-sm" viewBox="0 0 24 24">
                                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                            <line x1="16" y1="2" x2="16" y2="6"/>
                                            <line x1="8" y1="2" x2="8" y2="6"/>
                                            <line x1="3" y1="10" x2="21" y2="10"/>
                                        </svg>
                                        End Date & Time
                                    </label>
                                    <input type="datetime-local" id="end_date" name="end_date" class="form-input" required>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="discount_code" class="form-label">
                                    <svg class="icon icon-sm" viewBox="0 0 24 24">
                                        <path d="M21 12c.552 0 1-.448 1-1s-.448-1-1-1-1 .448-1 1 .448 1 1 1z"/>
                                        <path d="M3 12c.552 0 1-.448 1-1s-.448-1-1-1-1 .448-1 1 .448 1 1 1z"/>
                                        <path d="M12 21c.552 0 1-.448 1-1s-.448-1-1-1-1 .448-1 1 .448 1 1 1z"/>
                                        <path d="M12 3c.552 0 1-.448 1-1s-.448-1-1-1-1 .448-1 1 .448 1 1 1z"/>
                                    </svg>
                                    Discount Code (Optional)
                                </label>
                                <input type="text" id="discount_code" name="discount_code" class="form-input" placeholder="Enter discount code">
                                <div class="discount-hints">
                                    <span class="discount-hint">WELCOME20</span>
                                    <span class="discount-hint">LUXURY50</span>
                                    <span class="discount-hint">ELECTRIC15</span>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="loyalty_token_id" class="form-label">
                                    <svg class="icon icon-sm" viewBox="0 0 24 24">
                                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                                    </svg>
                                    Use Loyalty Token (Optional)
                                </label>
                                <select id="loyalty_token_id" name="loyalty_token_id" class="form-select">
                                    <option value="">No loyalty token</option>
                                    <!-- Loyalty tokens will be loaded here via JavaScript -->
                                </select>
                            </div>

                            <!-- Price Display -->
                            <div id="price-display" class="price-display hidden">
                                <!-- Price will be displayed here -->
                            </div>

                            <button type="submit" class="btn btn-primary btn-full btn-lg">
                                <svg class="icon icon-sm" viewBox="0 0 24 24">
                                    <path d="M9 12l2 2 4-4"/>
                                    <circle cx="12" cy="12" r="9"/>
                                </svg>
                                Book Now
                            </button>
                        </form>
                    </div>

                    <!-- Map and Vehicle Preview -->
                    <div class="card animate-slide-in-right">
                        <div class="card-header">
                            <h3 class="card-title">Pickup Locations</h3>
                            <div class="map-controls">
                                <button type="button" id="locate-btn" class="btn btn-outline btn-sm">
                                    <svg class="icon icon-sm" viewBox="0 0 24 24">
                                        <polygon points="3,11 22,2 13,21 11,13 3,11"/>
                                    </svg>
                                    Find Me
                                </button>
                            </div>
                        </div>
                        
                        <!-- Map container in the HTML -->
                        <div id="map" class="booking-map" style="height: 300px; border-radius: 1rem; margin-bottom: 1.5rem;"></div>
                        
                        <!-- Selected Vehicle Preview -->
                        <div id="vehicle-preview" class="vehicle-preview hidden">
                            <div class="preview-header">
                                <h4>Selected Vehicle</h4>
                            </div>
                            <div class="preview-content">
                                <div class="preview-image">
                                    <img id="preview-img" src="" alt="">
                                </div>
                                <div class="preview-details">
                                    <div class="preview-name" id="preview-name"></div>
                                    <div class="preview-type" id="preview-type"></div>
                                    <div class="preview-price" id="preview-price"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Available Vehicles -->
            <div class="vehicles-section">
                <div class="section-header">
                    <h2>Available Vehicles</h2>
                    <p>Choose from our premium collection</p>
                </div>
                
                <div class="vehicles-grid">
                    {% for vehicle in vehicles %}
                    <div class="vehicle-card animate-fade-in-up" style="animation-delay: {{ loop.index0 * 0.1 }}s;" onclick="selectVehicle({{ vehicle.id }})">
                        <div class="vehicle-image">
                            <img src="{{ vehicle.image_url }}" alt="{{ vehicle.make }} {{ vehicle.model }}">
                            <div class="vehicle-overlay">
                                <button class="btn btn-primary btn-sm">Select Vehicle</button>
                            </div>
                        </div>
                        <div class="vehicle-info">
                            <div class="vehicle-header">
                                <h3 class="vehicle-name">{{ vehicle.make }} {{ vehicle.model }}</h3>
                                <div class="vehicle-year">{{ vehicle.year }}</div>
                            </div>
                            <div class="vehicle-type">{{ vehicle.type }}</div>
                            <div class="vehicle-features">
                                <div class="feature">
                                    <svg class="icon icon-sm" viewBox="0 0 24 24">
                                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                                    </svg>
                                    Premium
                                </div>
                                <div class="feature">
                                    <svg class="icon icon-sm" viewBox="0 0 24 24">
                                        <path d="M9 12l2 2 4-4"/>
                                        <circle cx="12" cy="12" r="9"/>
                                    </svg>
                                    Available
                                </div>
                            </div>
                            <div class="vehicle-price">
                                <span class="price-amount">â‚¹{{ "%.2f"|format(vehicle.base_price) }}</span>
                                <span class="price-unit">/hour</span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </main>
    </div>

    <style>
        /* Booking Page Specific Styles */
        .booking-step {
            background: linear-gradient(135deg, var(--primary-500), var(--secondary-500));
            color: white;
            padding: var(--space-1) var(--space-3);
            border-radius: var(--radius-full);
            font-size: var(--text-xs);
            font-weight: 700;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-6);
            min-width: 0;
        }

        .form-row > .form-group {
            min-width: 0;
            max-width: 100%;
        }

        .form-group {
            margin-bottom: var(--space-6);
            word-break: break-word;
            white-space: normal;
        }

        .form-input {
            width: 100%;
            min-width: 0;
            max-width: 100%;
            padding: var(--space-3) var(--space-4);
            border: 2px solid var(--neutral-200);
            border-radius: var(--radius-lg);
            font-size: var(--text-base);
            background: white;
            transition: all var(--transition-fast);
            word-break: break-word;
            white-space: normal;
        }

        .form-label {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .discount-hints {
            display: flex;
            gap: var(--space-2);
            margin-top: var(--space-2);
            flex-wrap: wrap;
        }

        .discount-hint {
            background: var(--secondary-100);
            color: var(--secondary-700);
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-md);
            font-size: var(--text-xs);
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .discount-hint:hover {
            background: var(--secondary-200);
            transform: translateY(-1px);
        }

        .price-display {
            background: linear-gradient(135deg, var(--success-50), var(--primary-50));
            border: 2px solid var(--success-200);
            border-radius: var(--radius-3xl);
            padding: var(--space-6);
            margin: var(--space-6) 0;
            text-align: center;
        }

        .price-amount {
            font-size: var(--text-4xl);
            font-weight: 900;
            color: var(--success-700);
            margin-bottom: var(--space-2);
        }

        .price-details {
            color: var(--success-600);
            font-weight: 600;
        }

        .booking-map {
            height: 300px;
            border-radius: var(--radius-2xl);
            overflow: hidden;
            margin-bottom: var(--space-6);
        }

        .map-controls {
            display: flex;
            gap: var(--space-2);
        }

        .vehicle-preview {
            background: linear-gradient(135deg, var(--primary-50), var(--secondary-50));
            border: 2px solid var(--primary-200);
            border-radius: var(--radius-3xl);
            padding: var(--space-6);
        }

        .preview-header h4 {
            font-size: var(--text-lg);
            font-weight: 700;
            color: var(--primary-800);
            margin-bottom: var(--space-4);
        }

        .preview-content {
            display: flex;
            gap: var(--space-4);
            align-items: center;
        }

        .preview-image {
            width: 80px;
            height: 50px;
            border-radius: var(--radius-xl);
            overflow: hidden;
            flex-shrink: 0;
        }

        .preview-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .preview-details {
            flex: 1;
        }

        .preview-name {
            font-weight: 700;
            color: var(--primary-900);
            margin-bottom: var(--space-1);
        }

        .preview-type {
            font-size: var(--text-sm);
            color: var(--primary-600);
            margin-bottom: var(--space-1);
        }

        .preview-price {
            font-weight: 700;
            color: var(--secondary-600);
            font-size: var(--text-lg);
        }

        /* Vehicles Section */
        .vehicles-section {
            margin-top: var(--space-12);
        }

        .section-header {
            text-align: center;
            margin-bottom: var(--space-8);
        }

        .section-header h2 {
            font-size: var(--text-4xl);
            font-weight: 900;
            background: linear-gradient(135deg, var(--primary-600), var(--secondary-600));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: var(--space-2);
        }

        .section-header p {
            color: var(--neutral-600);
            font-size: var(--text-lg);
        }

        .vehicles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: var(--space-8);
        }

        .vehicle-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: var(--radius-3xl);
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all var(--transition-normal);
            cursor: pointer;
            position: relative;
        }

        .vehicle-card:hover {
            transform: translateY(-12px) scale(1.03);
            box-shadow: var(--shadow-2xl);
        }

        .vehicle-image {
            position: relative;
            height: 240px;
            overflow: hidden;
        }

        .vehicle-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform var(--transition-slow);
        }

        .vehicle-card:hover .vehicle-image img {
            transform: scale(1.1);
        }

        .vehicle-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity var(--transition-normal);
        }

        .vehicle-card:hover .vehicle-overlay {
            opacity: 1;
        }

        .vehicle-info {
            padding: var(--space-6);
        }

        .vehicle-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-2);
        }

        .vehicle-name {
            font-size: var(--text-xl);
            font-weight: 800;
            color: var(--neutral-900);
            margin-bottom: 0;
        }

        .vehicle-year {
            background: var(--neutral-100);
            color: var(--neutral-600);
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-md);
            font-size: var(--text-sm);
            font-weight: 600;
        }

        .vehicle-type {
            color: var(--neutral-600);
            margin-bottom: var(--space-4);
            font-weight: 500;
        }

        .vehicle-features {
            display: flex;
            gap: var(--space-3);
            margin-bottom: var(--space-4);
        }

        .feature {
            display: flex;
            align-items: center;
            gap: var(--space-1);
            font-size: var(--text-sm);
            color: var(--success-600);
            font-weight: 500;
        }

        .vehicle-price {
            display: flex;
            align-items: baseline;
            gap: var(--space-1);
        }

        .price-amount {
            font-size: var(--text-3xl);
            font-weight: 900;
            color: var(--secondary-600);
        }

        .price-unit {
            color: var(--neutral-600);
            font-weight: 500;
        }

        /* Feedback Styles */
        .feedback-success {
            background: #e6ffed;
            color: #15803d;
            border: 1px solid #bbf7d0;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        .feedback-error {
            background: #fef2f2;
            color: #b91c1c;
            border: 1px solid #fecaca;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        .feedback-info {
            background: #eff6ff;
            color: #1d4ed8;
            border: 1px solid #bfdbfe;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .grid-cols-2 {
                grid-template-columns: 1fr;
            }
            
            .vehicles-grid {
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .vehicles-grid {
                grid-template-columns: 1fr;
            }
            
            .preview-content {
                flex-direction: column;
                text-align: center;
            }
            
            .preview-image {
                width: 120px;
                height: 75px;
            }
        }
    </style>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
  document.addEventListener('DOMContentLoaded', function() {
    var mapContainer = document.getElementById('map');
    if (mapContainer && typeof L !== 'undefined' && !mapContainer._leaflet_id) {
      var defaultLat = 10.0270;
      var defaultLng = 76.3083;
      var map = L.map('map', { attributionControl: false }).setView([defaultLat, defaultLng], 15);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '',
      }).addTo(map);
      var pickupMarker = null;
      function setPickupMarker(lat, lng, popupText) {
        if (pickupMarker) map.removeLayer(pickupMarker);
        pickupMarker = L.marker([lat, lng]).addTo(map).bindPopup(popupText || 'Pickup Location').openPopup();
        let bookingForm = document.getElementById('booking-form');
        let latInput = document.getElementById('pickup_lat');
        let lngInput = document.getElementById('pickup_lng');
        if (!latInput) {
          latInput = document.createElement('input');
          latInput.type = 'hidden';
          latInput.id = 'pickup_lat';
          latInput.name = 'pickup_lat';
          bookingForm.appendChild(latInput);
        }
        if (!lngInput) {
          lngInput = document.createElement('input');
          lngInput.type = 'hidden';
          lngInput.id = 'pickup_lng';
          lngInput.name = 'pickup_lng';
          bookingForm.appendChild(lngInput);
        }
        latInput.value = lat;
        lngInput.value = lng;
      }
      map.on('click', function(e) {
        setPickupMarker(e.latlng.lat, e.latlng.lng, 'Pickup Location');
      });
    }
  });
</script>
    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
    <script>
        // Initialize map
        let map = L.map('map').setView([40.7128, -74.0060], 12);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        let currentMarker = null;
        const vehicles = {{ vehicles|tojson }};

        // Vehicle selection
        function selectVehicle(vehicleId) {
            const vehicleSelect = document.getElementById('vehicle_id');
            vehicleSelect.value = vehicleId;
            vehicleSelect.dispatchEvent(new Event('change'));
            
            // Scroll to form
            document.querySelector('.booking-form').scrollIntoView({ 
                behavior: 'smooth',
                block: 'start'
            });
        }

        // Update vehicle selection when dropdown changes
        document.getElementById('vehicle_id').addEventListener('change', function() {
            const vehicleId = parseInt(this.value);
            const vehicle = vehicles.find(v => v.id === vehicleId);
            
            if (vehicle) {
                updateMap(vehicle);
                updateVehiclePreview(vehicle);
                calculatePrice();
            }
        });

        function updateMap(vehicle) {
            if (vehicle.pickup_location_lat && vehicle.pickup_location_lng) {
                if (currentMarker) {
                    map.removeLayer(currentMarker);
                }
                
                currentMarker = L.marker([vehicle.pickup_location_lat, vehicle.pickup_location_lng])
                    .addTo(map)
                    .bindPopup(`
                        <div style="text-align: center;">
                            <strong>${vehicle.make} ${vehicle.model}</strong><br>
                            ${vehicle.year} ${vehicle.type}<br>
                            <strong>â‚¹${vehicle.base_price}/hour</strong>
                        </div>
                    `)
                    .openPopup();
                
                map.setView([vehicle.pickup_location_lat, vehicle.pickup_location_lng], 14);
            }
        }

        function updateVehiclePreview(vehicle) {
            const preview = document.getElementById('vehicle-preview');
            const img = document.getElementById('preview-img');
            const name = document.getElementById('preview-name');
            const type = document.getElementById('preview-type');
            const price = document.getElementById('preview-price');
            
            img.src = vehicle.image_url;
            img.alt = `${vehicle.make} ${vehicle.model}`;
            name.textContent = `${vehicle.make} ${vehicle.model}`;
            type.textContent = `${vehicle.year} ${vehicle.type}`;
            price.textContent = `â‚¹${vehicle.base_price}/hour`;
            
            preview.classList.remove('hidden');
        }

        // Set minimum date to current time
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        const nowString = now.toISOString().slice(0, 16);
        document.getElementById('start_date').min = nowString;
        document.getElementById('end_date').min = nowString;

        // Validate end date is after start date
        document.getElementById('start_date').addEventListener('change', function() {
            document.getElementById('end_date').min = this.value;
            if (document.getElementById('end_date').value && document.getElementById('end_date').value <= this.value) {
                document.getElementById('end_date').value = '';
            }
            calculatePrice();
        });

        document.getElementById('end_date').addEventListener('change', calculatePrice);

        // Discount hint clicks
        document.querySelectorAll('.discount-hint').forEach(hint => {
            hint.addEventListener('click', function() {
                document.getElementById('discount_code').value = this.textContent;
            });
        });

        // Locate button
        document.getElementById('locate-btn').addEventListener('click', function() {
            if (navigator.geolocation) {
                this.innerHTML = '<svg class="icon icon-sm" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/></svg> Locating...';
                this.disabled = true;
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        map.setView([lat, lng], 14);
                        
                        L.marker([lat, lng])
                            .addTo(map)
                            .bindPopup('Your location')
                            .openPopup();
                        
                        this.innerHTML = '<svg class="icon icon-sm" viewBox="0 0 24 24"><polygon points="3,11 22,2 13,21 11,13 3,11"/></svg> Located!';
                        this.disabled = false;
                        
                        setTimeout(() => {
                            this.innerHTML = '<svg class="icon icon-sm" viewBox="0 0 24 24"><polygon points="3,11 22,2 13,21 11,13 3,11"/></svg> Find Me';
                        }, 2000);
                    },
                    (error) => {
                        this.innerHTML = '<svg class="icon icon-sm" viewBox="0 0 24 24"><polygon points="3,11 22,2 13,21 11,13 3,11"/></svg> Error';
                        this.disabled = false;
                        
                        setTimeout(() => {
                            this.innerHTML = '<svg class="icon icon-sm" viewBox="0 0 24 24"><polygon points="3,11 22,2 13,21 11,13 3,11"/></svg> Find Me';
                        }, 2000);
                    }
                );
            }
        });

        // Update price calculation function
        function calculatePrice() {
            const vehicleId = document.getElementById('vehicle_id').value;
            const startDate = document.getElementById('start_date').value;
            const endDate = document.getElementById('end_date').value;
            const priceDisplay = document.getElementById('price-display');
            clearBookingFeedback();
            if (!vehicleId || !startDate || !endDate) {
                priceDisplay.classList.add('hidden');
                return;
            }
            priceDisplay.innerHTML = `
                <div class="price-amount">Calculating...</div>
                <div class="price-details">Please wait</div>
            `;
            priceDisplay.classList.remove('hidden');
            fetch('/api/calculate_price', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    vehicle_id: vehicleId,
                    start_date: startDate,
                    end_date: endDate
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.price) {
                    const start = new Date(startDate);
                    const end = new Date(endDate);
                    const hours = Math.ceil((end - start) / (1000 * 60 * 60));
                    priceDisplay.innerHTML = `
                        <div class="price-amount">â‚¹${data.price.toFixed(2)}</div>
                        <div class="price-details">
                            Total for ${hours} hour${hours !== 1 ? 's' : ''}
                            <br>
                            <small>Includes dynamic pricing adjustments</small>
                        </div>
                    `;
                } else {
                    priceDisplay.innerHTML = `
                        <div class="price-amount">Error</div>
                        <div class="price-details">${data.error || 'Unable to calculate price'}</div>
                    `;
                    showBookingFeedback(data.error || 'Unable to calculate price', 'error');
                }
            })
            .catch(error => {
                priceDisplay.innerHTML = `
                    <div class="price-amount">Error</div>
                    <div class="price-details">Please try again</div>
                `;
                showBookingFeedback('An error occurred while calculating price.', 'error');
            });
        }

        // Load loyalty tokens for the user and populate the dropdown
        function loadLoyaltyTokens() {
            fetch('/api/loyalty_tokens')
                .then(response => response.json())
                .then(data => {
                    const select = document.getElementById('loyalty_token_id');
                    // Remove all except the first option
                    select.innerHTML = '<option value="">No loyalty token</option>';
                    if (data.tokens && data.tokens.length > 0) {
                        data.tokens.forEach(token => {
                            const option = document.createElement('option');
                            option.value = token.id;
                            option.textContent = `â‚¹${token.token_value} - ${token.description || 'Loyalty Reward'}` + (token.expiry_date ? ` (Expires: ${token.expiry_date})` : '');
                            select.appendChild(option);
                        });
                    }
                });
        }
        // Call on page load
        document.addEventListener('DOMContentLoaded', loadLoyaltyTokens);

        // Mobile menu functionality
        document.addEventListener('DOMContentLoaded', () => {
            // Removed sidebar and sidebar overlay logic
        });

        // Custom form validation and focus management
        const bookingForm = document.getElementById('booking-form');
        const bookingMessage = document.getElementById('booking-message');
        function showBookingMessage(message, type = 'info') {
            bookingMessage.textContent = message;
            bookingMessage.className = type === 'success' ? 'feedback-success' : type === 'error' ? 'feedback-error' : 'feedback-info';
            bookingMessage.style.display = 'block';
            bookingMessage.focus();
        }
        function clearBookingMessage() {
            bookingMessage.textContent = '';
            bookingMessage.className = '';
            bookingMessage.style.display = 'none';
        }
        bookingForm.addEventListener('submit', function(e) {
            clearBookingMessage();
            let hasError = false;
            let firstErrorField = null;
            // Validate required fields
            ['vehicle_id','start_date','end_date'].forEach(id => {
                const field = document.getElementById(id);
                if (!field.value) {
                    hasError = true;
                    if (!firstErrorField) firstErrorField = field;
                }
            });
            if (hasError) {
                e.preventDefault();
                showBookingMessage('Please fill in all required fields.', 'error');
                if (firstErrorField) firstErrorField.focus();
                return false;
            }
            // Optionally, show a confirmation message after successful submit (AJAX flow)
            // showBookingMessage('Booking submitted successfully!', 'success');
        });
    </script>
</body>
</html>